<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>極・しりとり検索 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input, select, button { font-size: 16px !important; touch-action: manipulation; }
        .tab-active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 pb-20">
    <div class="max-w-md mx-auto px-4 pt-6">
        <div class="bg-white rounded-3xl shadow-xl p-6 space-y-4 border border-white">
            <div class="flex justify-between items-center">
                <h1 class="font-black text-indigo-600 italic tracking-tight">SHIRITORI ENGINE v2026</h1>
                <button onclick="location.reload()" class="text-[10px] font-bold text-red-500 bg-red-50 px-3 py-1 rounded-full uppercase">Reset</button>
            </div>

            <div class="space-y-2">
                <input id="startWord" oninput="toKatakana(this)" placeholder="開始単語 (任意)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none ring-1 ring-slate-100 focus:ring-2 focus:ring-indigo-500">
                <div class="grid grid-cols-3 gap-2">
                    <input id="startChar" oninput="toKatakana(this)" placeholder="開始字" class="p-4 bg-slate-50 rounded-2xl outline-none ring-1 ring-slate-100 focus:ring-2 focus:ring-indigo-500 text-center">
                    <input id="mustChar" oninput="toKatakana(this)" placeholder="必須字" class="p-4 bg-slate-50 rounded-2xl outline-none ring-1 ring-slate-100 focus:ring-2 focus:ring-orange-500 text-center">
                    <input id="endChar" oninput="toKatakana(this)" placeholder="終了字" class="p-4 bg-slate-50 rounded-2xl outline-none ring-1 ring-slate-100 focus:ring-2 focus:ring-indigo-500 text-center">
                </div>
            </div>

            <div class="grid grid-cols-3 gap-1 p-1 bg-slate-100 rounded-2xl">
                <button onclick="setCat('countries')" id="cat-countries" class="text-[10px] font-bold py-2 rounded-xl transition-all">国</button>
                <button onclick="setCat('capitals')" id="cat-capitals" class="text-[10px] font-bold py-2 rounded-xl transition-all">首都</button>
                <button onclick="setCat('both')" id="cat-both" class="tab-active text-[10px] font-bold py-2 rounded-xl transition-all">両方</button>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col bg-slate-50 p-4 rounded-2xl ring-1 ring-slate-100">
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-2">ずらし量</label>
                    <div class="flex items-center justify-between">
                        <button onclick="adjShift(-1)" class="w-8 h-8 bg-white rounded-full shadow-sm font-bold text-indigo-600">-</button>
                        <span id="shiftDisp" class="font-black text-lg">+1</span>
                        <button onclick="adjShift(1)" class="w-8 h-8 bg-white rounded-full shadow-sm font-bold text-indigo-600">+</button>
                    </div>
                </div>
                <div class="flex flex-col bg-slate-50 p-4 rounded-2xl ring-1 ring-slate-100 justify-center items-center">
                    <label class="text-[10px] font-black text-slate-400 uppercase mb-2">牛耕(往復)</label>
                    <input type="checkbox" id="gyukou" class="w-7 h-7 accent-indigo-600">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="flex flex-col bg-slate-50 p-4 rounded-2xl ring-1 ring-slate-100">
                    <span class="text-[10px] font-black text-slate-400 uppercase mb-2">ルート長</span>
                    <div class="flex items-center justify-between">
                        <button onclick="adjLen(-1)" class="w-8 h-8 bg-white rounded-full shadow-sm font-bold">-</button>
                        <span id="lenDisp" class="font-black text-lg">5</span>
                        <button onclick="adjLen(1)" class="w-8 h-8 bg-white rounded-full shadow-sm font-bold">+</button>
                    </div>
                </div>
                <div class="flex flex-col bg-slate-50 p-4 rounded-2xl ring-1 ring-slate-100">
                    <span class="text-[10px] font-black text-slate-400 uppercase mb-2">表示順</span>
                    <select id="sortType" class="bg-transparent font-bold text-sm outline-none mt-1">
                        <option value="default">標準</option>
                        <option value="length_desc">文字数多</option>
                        <option value="length_asc">文字数少</option>
                        <option value="shuffle">ランダム</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 px-1">
                <label class="flex justify-between items-center text-[10px] font-bold">
                    <span>濁点無視</span>
                    <input type="checkbox" id="voice" class="w-6 h-6 accent-indigo-600">
                </label>
                <label class="flex justify-between items-center text-[10px] font-bold">
                    <span>共役排除</span>
                    <input type="checkbox" id="excludeConjugate" class="w-6 h-6 accent-orange-600">
                </label>
            </div>

            <button onclick="openModal()" class="w-full py-2 text-[10px] font-bold text-indigo-500 bg-indigo-50 rounded-xl">単語詳細・除外設定</button>
            <button onclick="run()" id="runBtn" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-all text-lg">探索開始</button>
        </div>

        <div id="statusArea" class="mt-6 flex justify-between items-center px-2 hidden">
            <div id="status" class="text-lg font-black text-slate-800"></div>
            <button onclick="copyAll()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-full">全文コピー</button>
        </div>
        <div id="results" class="mt-2 space-y-3"></div>
    </div>

    <!-- モーダル -->
    <div id="modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-h-[80vh] rounded-3xl p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 font-bold"><span>詳細設定</span><button onclick="closeModal()" class="text-xl">✕</button></div>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="presetExclude('island')" class="py-2 bg-red-50 text-red-600 text-[10px] font-bold rounded-lg">島国を一括除外</button>
                <button onclick="presetExclude('long')" class="py-2 bg-orange-50 text-orange-600 text-[10px] font-bold rounded-lg">8文字以上除外</button>
            </div>

            <div class="overflow-y-auto space-y-1">
                {% for w in all_words %}
                <div class="flex justify-between items-center p-2 border-b text-xs">
                    <span>{{ w }}</span>
                    <select id="cfg-{{ w }}" onchange="updateCfg('{{ w }}', this.value)" class="p-1 bg-slate-50 rounded">
                        <option value="0">可</option><option value="1">必須</option><option value="2">不可</option>
                    </select>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        let length = 5; let shift = 1; let wordConfigs = {}; let category = 'both';
        function toKatakana(el) { el.value = el.value.replace(/[ぁ-ん]/g, s => String.fromCharCode(s.charCodeAt(0) + 0x60)); }
        function adjLen(v) { length = Math.max(2, Math.min(12, length + v)); document.getElementById('lenDisp').innerText = length; }
        function adjShift(v) { shift += v; document.getElementById('shiftDisp').innerText = (shift >= 0 ? "+" : "") + shift; }
        function setCat(c) { category = c; ['countries','capitals','both'].forEach(id => document.getElementById('cat-'+id).classList.remove('tab-active')); document.getElementById('cat-'+c).classList.add('tab-active'); }
        function updateCfg(w, v) { wordConfigs[w] = parseInt(v); }
        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        
        function presetExclude(type) {
            const islandNations = ["アイスランド", "日本", "フィリピン", "インドネシア", "マダガスカル", "ニュージーランド", "キューバ", "イギリス", "スリランカ"];
            const allWords = Array.from(document.querySelectorAll('[id^="cfg-"]'));
            allWords.forEach(el => {
                const name = el.id.replace('cfg-', '');
                if (type === 'island' && islandNations.includes(name)) {
                    el.value = "2"; updateCfg(name, 2);
                } else if (type === 'long' && name.length >= 8) {
                    el.value = "2"; updateCfg(name, 2);
                }
            });
        }

        async function run() {
            const btn = document.getElementById('runBtn'); btn.disabled = true;
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('status').innerText = "探索中...";
            const res = await fetch('/search', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    start_word: document.getElementById('startWord').value,
                    start_char: document.getElementById('startChar').value,
                    must_char: document.getElementById('mustChar').value,
                    end_char: document.getElementById('endChar').value,
                    shift_count: shift,
                    is_gyukou: document.getElementById('gyukou').checked,
                    ignore_voiced: document.getElementById('voice').checked,
                    exclude_conjugate: document.getElementById('excludeConjugate').checked,
                    category: category,
                    max_len: length,
                    word_configs: wordConfigs,
                    sort_type: document.getElementById('sortType').value
                })
            });
            const data = await res.json();
            btn.disabled = false;
            document.getElementById('status').innerText = `${data.count}件ヒット`;
            document.getElementById('results').innerHTML = data.routes.map(r => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <div class="route-text font-bold text-indigo-900 mb-2">${r.join(' → ')}</div>
                    <button onclick="navigator.clipboard.writeText('${r.join(' → ')}')" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Copy Route</button>
                </div>
            `).join('');
        }
        function copyAll() {
            const t = Array.from(document.querySelectorAll('.route-text')).map(el => el.innerText).join('\n');
            navigator.clipboard.writeText(t); alert("全てコピーしました");
        }
    </script>
</body>
</html>
